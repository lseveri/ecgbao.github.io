
 <!DOCTYPE HTML>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  
    <title>UISearchController 使用指导 | 跳跳魔王的博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="跳跳魔王">
    

    
    <meta name="description" content="这么多的数据，这么少的时间。

如果你的程序要展示大量的数据集, 通过滚动大规模的列表会变的很慢并且令人沮丧。 既然如此，允许用户搜索特定项目就显得非常重要。 幸运的是, UIKit 包含的 UISearchBar 和 UITableView实现了无缝对接来进行快速有效的信息过滤。这份UISearchController 指导, 你将建立一个基于标准">
<meta property="og:type" content="article">
<meta property="og:title" content="UISearchController 使用指导">
<meta property="og:url" content="http://yoursite.com/2016/09/14/UISearchController-使用指导/index.html">
<meta property="og:site_name" content="跳跳魔王的博客">
<meta property="og:description" content="这么多的数据，这么少的时间。

如果你的程序要展示大量的数据集, 通过滚动大规模的列表会变的很慢并且令人沮丧。 既然如此，允许用户搜索特定项目就显得非常重要。 幸运的是, UIKit 包含的 UISearchBar 和 UITableView实现了无缝对接来进行快速有效的信息过滤。这份UISearchController 指导, 你将建立一个基于标准">
<meta property="og:image" content="http://www.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Square.png">
<meta property="og:image" content="http://www.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Starter-281x500.png">
<meta property="og:image" content="http://www.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Data-281x500.png">
<meta property="og:image" content="http://www.raywenderlich.com/wp-content/uploads/2015/09/darkchocolate.png">
<meta property="og:image" content="http://www.raywenderlich.com/wp-content/uploads/2015/09/ragecomic.png">
<meta property="og:image" content="http://www.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Filter-281x500.png">
<meta property="og:image" content="http://www.raywenderlich.com/wp-content/uploads/2015/09/CandySearch-DetailView-281x500.png">
<meta property="og:image" content="http://www.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Filter-with-Scope-281x500.png">
<meta property="og:image" content="http://www.raywenderlich.com/wp-content/uploads/2012/07/nosearchfunction.jpg">
<meta property="og:updated_time" content="2016-09-14T03:29:21.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="UISearchController 使用指导">
<meta name="twitter:description" content="这么多的数据，这么少的时间。

如果你的程序要展示大量的数据集, 通过滚动大规模的列表会变的很慢并且令人沮丧。 既然如此，允许用户搜索特定项目就显得非常重要。 幸运的是, UIKit 包含的 UISearchBar 和 UITableView实现了无缝对接来进行快速有效的信息过滤。这份UISearchController 指导, 你将建立一个基于标准">
<meta name="twitter:image" content="http://www.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Square.png">

    
    <link rel="alternative" href="/atom.xml" title="跳跳魔王的博客" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="跳跳魔王的博客">跳跳魔王的博客</a></h1>
				<h2 class="blog-motto">每天进步一点点</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:yoursite.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/09/14/UISearchController-使用指导/" title="UISearchController 使用指导" itemprop="url">UISearchController 使用指导</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="跳跳魔王" target="_blank" itemprop="author">跳跳魔王</a>
		
  <p class="article-time">
    <time datetime="2016-09-14T00:59:02.000Z" itemprop="datePublished"> Published 2016-09-14</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">1.</span> <span class="toc-text">准备开始</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">2.</span> <span class="toc-text">填充 Table View</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.</span> <span class="toc-text">UISearchController介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.1.</span> <span class="toc-text">UISearchResultsUpdating 和 Filtering</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">4.</span> <span class="toc-text">Sending Data to a Detail View</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">5.</span> <span class="toc-text">Creating a Scope Bar to Filter Results</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">6.</span> <span class="toc-text">Where To Go From Here?</span></a></li></ol>
		
		</div>
		
		<div class="content-wrapper"><br>                        <div id="attachment_78152" style="width: 260px" class="wp-caption alignright"><img src="http://www.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Square.png" alt="UISearchBar-square" width="250" height="250" class="alignright size-thumbnail wp-image-78152"><p class="wp-caption-text">这么多的数据，这么少的时间。</p></div>

<p>如果你的程序要展示大量的数据集, 通过滚动大规模的列表会变的很慢并且令人沮丧。 既然如此，允许用户搜索特定项目就显得非常重要。 幸运的是, UIKit 包含的 <code>UISearchBar</code> 和 <code>UITableView</code>实现了无缝对接来进行快速有效的信息过滤。</p><br><p>这份<code>UISearchController</code> 指导, 你将建立一个基于标准列表的Candy 应用。 你会添加搜索的功能, 包括动态过滤, 可选的scope bar, 所有使用 <code>UISearchController</code>的方式, 都已经添加到iOS 8. 最后, 你会知道如何让你的程序更加友好并且满足用户的紧急需求。</p><br><p>预备好一些糖衣的搜索结果，继续读下去。</p><br><h2>准备开始</h2><br><p>下载演示程序在<a href="http://www.raywenderlich.com/wp-content/uploads/2015/09/CandySearch-Starter.zip" target="_blank" rel="external">这里</a> 然后打开。 程序以导航栏的风格创建，编译项目并运行，你会看到一个空列表:</p><br><p><a href="http://www.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Starter.png" target="_blank" rel="external"><img src="http://www.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Starter-281x500.png" alt="UISearchController-Starter" width="281" height="500" class="aligncenter size-large wp-image-113862" srcset="https://cdn5.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Starter-281x500.png 281w, https://cdn5.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Starter-180x320.png 180w, https://cdn5.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Starter.png 750w" sizes="(max-width: 281px) 100vw, 281px"></a></p><br><p>回到Xcode, 文件<em>Candy.swift</em> 包含了一个用来保存你想展示的糖果信息的类。这个类有两个属性: 分类和糖果名。</p><br><p>当用户在你的app搜索某个糖果的时候, 你要引用名字属性来匹配用户的搜索关键字。 你会在文章结尾实现的Scope Bar中看到分类字符串的重要性。</p><br><h2>填充 Table View</h2><br><p>打开 <em>MasterViewController.swift</em>.  <code>candies</code> 属性负责管理用户搜索用的不同的<code>Candy</code>对象。 说到这里, 是时候创建一些 Candy了!</p><br><p>这个指导中, 你只需要创建固定数量的数据来展示search bar如何工作的; 在真正的产品级应用中, 你可能会有上千条的数据。不过无论怎样，不管程序存在上千的数据还是只有一点点数据，用到的方法都是一样的。 出色的扩展性!</p><br><p>填充你的 <code>candies</code> 数组,添加下面的代码到 <code>viewDidLoad()</code>, 代码添加在 <code>super.viewDidLoad()</code>调用后:</p>

<div class="wp_codebox"><table><tr id="p1137721"><td class="code" id="p113772code1"><pre class="swift" style="font-family:monospace;">candies <span style="color: #002200;">=</span> <span style="color: #002200;">&#91;</span><br>  Candy<span style="color: #002200;">&#40;</span>category<span style="color: #002200;">:</span><span style="color: #bf1d1a;">&quot;Chocolate&quot;</span>, name<span style="color: #002200;">:</span><span style="color: #bf1d1a;">&quot;Chocolate Bar&quot;</span><span style="color: #002200;">&#41;</span>,<br>  Candy<span style="color: #002200;">&#40;</span>category<span style="color: #002200;">:</span><span style="color: #bf1d1a;">&quot;Chocolate&quot;</span>, name<span style="color: #002200;">:</span><span style="color: #bf1d1a;">&quot;Chocolate Chip&quot;</span><span style="color: #002200;">&#41;</span>,<br>  Candy<span style="color: #002200;">&#40;</span>category<span style="color: #002200;">:</span><span style="color: #bf1d1a;">&quot;Chocolate&quot;</span>, name<span style="color: #002200;">:</span><span style="color: #bf1d1a;">&quot;Dark Chocolate&quot;</span><span style="color: #002200;">&#41;</span>,<br>  Candy<span style="color: #002200;">&#40;</span>category<span style="color: #002200;">:</span><span style="color: #bf1d1a;">&quot;Hard&quot;</span>, name<span style="color: #002200;">:</span><span style="color: #bf1d1a;">&quot;Lollipop&quot;</span><span style="color: #002200;">&#41;</span>,<br>  Candy<span style="color: #002200;">&#40;</span>category<span style="color: #002200;">:</span><span style="color: #bf1d1a;">&quot;Hard&quot;</span>, name<span style="color: #002200;">:</span><span style="color: #bf1d1a;">&quot;Candy Cane&quot;</span><span style="color: #002200;">&#41;</span>,<br>  Candy<span style="color: #002200;">&#40;</span>category<span style="color: #002200;">:</span><span style="color: #bf1d1a;">&quot;Hard&quot;</span>, name<span style="color: #002200;">:</span><span style="color: #bf1d1a;">&quot;Jaw Breaker&quot;</span><span style="color: #002200;">&#41;</span>,<br>  Candy<span style="color: #002200;">&#40;</span>category<span style="color: #002200;">:</span><span style="color: #bf1d1a;">&quot;Other&quot;</span>, name<span style="color: #002200;">:</span><span style="color: #bf1d1a;">&quot;Caramel&quot;</span><span style="color: #002200;">&#41;</span>,<br>  Candy<span style="color: #002200;">&#40;</span>category<span style="color: #002200;">:</span><span style="color: #bf1d1a;">&quot;Other&quot;</span>, name<span style="color: #002200;">:</span><span style="color: #bf1d1a;">&quot;Sour Chew&quot;</span><span style="color: #002200;">&#41;</span>,<br>  Candy<span style="color: #002200;">&#40;</span>category<span style="color: #002200;">:</span><span style="color: #bf1d1a;">&quot;Other&quot;</span>, name<span style="color: #002200;">:</span><span style="color: #bf1d1a;">&quot;Gummi Bear&quot;</span><span style="color: #002200;">&#41;</span><br><span style="color: #002200;">&#93;</span></pre></td></tr></table></div>

<p>再次编译运行你的工程。因为table view的代理和数据源方法都已经实现了，现在你可以看见一个有数据的table view了: </p><br><p><a href="http://www.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Data.png" target="_blank" rel="external"><img src="http://www.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Data-281x500.png" alt="UISearchController-Data" width="281" height="500" class="aligncenter size-large wp-image-113861" srcset="https://cdn2.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Data-281x500.png 281w, https://cdn2.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Data-180x320.png 180w, https://cdn2.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Data.png 750w" sizes="(max-width: 281px) 100vw, 281px"></a></p><br><p>选择列表的一行，点击进入会展示对应糖果的详情页:</p><br><p><a href="http://www.raywenderlich.com/wp-content/uploads/2015/09/darkchocolate.png" target="_blank" rel="external"><img src="http://www.raywenderlich.com/wp-content/uploads/2015/09/darkchocolate.png" alt="Dark Chocolate" width="281" height="500" class="aligncenter size-large wp-image-115841" srcset="https://cdn2.raywenderlich.com/wp-content/uploads/2015/09/darkchocolate.png 375w, https://cdn2.raywenderlich.com/wp-content/uploads/2015/09/darkchocolate-180x320.png 180w, https://cdn2.raywenderlich.com/wp-content/uploads/2015/09/darkchocolate-281x500.png 281w" sizes="(max-width: 281px) 100vw, 281px"></a></p><br><p>这么多的糖果，这么少的时间找到你想要的! 你需要一个<code>UISearchBar</code>.</p><br><h2>UISearchController介绍</h2><br><p>如果你查看<code>UISearchController</code> 文档, 你会发现这个文档懒的令人发指。 他一点搜索工作都不做。 这个类只是提供用户预期得到的标准接口而已。</p><br><p><code>UISearchController</code> 调用代理方法告知你的应用其他地方，你的用户正在做什么。你必须自己实现所有的函数来做字符串的匹配工作。</p><br><p>虽然这看起来有点吓人, 但是写自定义的搜索功能你可以自己控制准确的返回结果。 你的用户会非常赞赏这种智能快速的搜索。</p><br><p>如果你过去用过搜索列表, 你应该熟悉<code>UISearchDisplayController</code>。 从 iOS 8开始, 这个类已经被弃用，现在开始使用 <code>UISearchController</code>, 这个类简化了搜索的流程。</p><br><p>不走运的是, 写这篇文章的时候, Interface Builder 还不支持 <code>UISearchController</code>, 因此你要自己手动创建你的UI。</p><br><p>在 <em>MasterViewController.swift</em>, 添加一个新的属性:</p>

<div class="wp_codebox"><table><tr id="p1137722"><td class="code" id="p113772code2"><pre class="swift" style="font-family:monospace;"><span style="color: #a61390;">let</span> searchController <span style="color: #002200;">=</span> UISearchController<span style="color: #002200;">&#40;</span>searchResultsController<span style="color: #002200;">:</span> <span style="color: #a61390;">nil</span><span style="color: #002200;">&#41;</span></pre></td></tr></table></div>

<p>通过初始化 <code>UISearchController</code> 不带 <code>searchResultsController</code>, 告诉搜索页面你要用相同的搜索视图来展示搜索结果。如果你在这里用不同的视图控制器，那搜索结果就展示在替代的视图里。</p><br><p>下一步, 你需要给你的搜索视图控制器配置一些参数。还是在 <em>MasterViewController.swift</em>里面, 在 <code>viewDidLoad()</code>后面添加如下代码:</p>

<div class="wp_codebox"><table><tr id="p1137723"><td class="code" id="p113772code3"><pre class="swift" style="font-family:monospace;">  searchController.searchResultsUpdater <span style="color: #002200;">=</span> <span style="color: #a61390;">self</span><br>  searchController.dimsBackgroundDuringPresentation <span style="color: #002200;">=</span> <span style="color: #a61390;">false</span><br>  definesPresentationContext <span style="color: #002200;">=</span> <span style="color: #a61390;">true</span><br>  tableView.tableHeaderView <span style="color: #002200;">=</span> searchController.searchBar</pre></td></tr></table></div>

<p>这儿是你添加代码的说明:</p><br><ol><br><li><code>searchResultsUpdater</code> 是 <code>UISearchController</code>的属性遵守 <code>UISearchResultsUpdating</code>协议。 当<code>UISearchBar</code>中输入的文字改变时，该协议会通知你的类. 过会你就会在你的类实现这个协议的。</li><br><li>默认情况下, <code>UISearchController</code>出现时视图会黯淡下来。 当你使用别的视图控制器作为<code>searchResultsController</code>时会很有用. 这个情况下, 你已经设置当前视图来显示结果，因此你不希望视图是黯淡的。</li><br><li>通过在视图控制器设置<code>definesPresentationContext</code> 为 <code>true</code>, 当<code>UISearchController</code> 处于激活状态是，确保用户在导航到别的页面后,搜索条不会继续留在屏幕上。</li><br><li>最后, 添加 <code>searchBar</code> 到列表的 <code>tableHeaderView</code>。记住 Interface Builder 还不兼容<code>UISearchController</code>, 这个很必要。</li><br></ol><br><h3>UISearchResultsUpdating 和 Filtering</h3><br><p>建立好搜索控制之后, 你需要做一些编码工作来让它工作。 首先, 在<code>MasterViewController</code>顶部附近添加下面的属性:</p>

<div class="wp_codebox"><table><tr id="p1137724"><td class="code" id="p113772code4"><pre class="swift" style="font-family:monospace;"><span style="color: #a61390;">var</span> filteredCandies <span style="color: #002200;">=</span> <span style="color: #002200;">&#91;</span>Candy<span style="color: #002200;">&#93;</span><span style="color: #002200;">&#40;</span><span style="color: #002200;">&#41;</span></pre></td></tr></table></div>

<p>这个属性用例保存用户正在搜索的糖果。 下一步, 添加下面的辅助方法到 <code>MasterViewController</code>:</p>

<div class="wp_codebox"><table><tr id="p1137725"><td class="code" id="p113772code5"><pre class="swift" style="font-family:monospace;"><span style="color: #a61390;">func</span> filterContentForSearchText<span style="color: #002200;">&#40;</span>searchText<span style="color: #002200;">:</span> <span style="color: #a61390;">String</span>, scope<span style="color: #002200;">:</span> <span style="color: #a61390;">String</span> <span style="color: #002200;">=</span> <span style="color: #bf1d1a;">&quot;All&quot;</span><span style="color: #002200;">&#41;</span> <span style="color: #002200;">&#123;</span><br>  filteredCandies <span style="color: #002200;">=</span> candies.<span style="color: #a61390;">filter</span> <span style="color: #002200;">&#123;</span> candy <span style="color: #a61390;">in</span><br>    <span style="color: #a61390;">return</span> candy.name.lowercaseString.containsString<span style="color: #002200;">&#40;</span>searchText.lowercaseString<span style="color: #002200;">&#41;</span><br>  <span style="color: #002200;">&#125;</span><br>&nbsp;<br>  tableView.reloadData<span style="color: #002200;">&#40;</span><span style="color: #002200;">&#41;</span><br><span style="color: #002200;">&#125;</span></pre></td></tr></table></div>

<p>这个方法会通过<code>searchText</code>过滤<code>candies</code> 数据并把结果放进你刚刚添加的 <code>filteredCandies</code> 数组。现在不用担心<code>scope</code> 这个参数, 文章后面你会用到它。</p><br><p>To allow <code>MasterViewController</code> to respond to the search bar, it will have to implement <code>UISearchResultsUpdating</code>. Open <em>MasterViewController.swift</em> and add the following class extension, outside of the main <code>MasterViewController</code> class:</p>

<div class="wp_codebox"><table><tr id="p1137726"><td class="code" id="p113772code6"><pre class="swift" style="font-family:monospace;">extension MasterViewController<span style="color: #002200;">:</span> UISearchResultsUpdating <span style="color: #002200;">&#123;</span><br>  <span style="color: #a61390;">func</span> updateSearchResultsForSearchController<span style="color: #002200;">&#40;</span>searchController<span style="color: #002200;">:</span> UISearchController<span style="color: #002200;">&#41;</span> <span style="color: #002200;">&#123;</span><br>    filterContentForSearchText<span style="color: #002200;">&#40;</span>searchController.searchBar.text<span style="color: #002200;">!</span><span style="color: #002200;">&#41;</span><br>  <span style="color: #002200;">&#125;</span><br><span style="color: #002200;">&#125;</span></pre></td></tr></table></div>

<p>The <code>updateSearchResultsForSearchController(<em>:)</em></code> method is the one and only method that your class <i>must</i> implement to conform to the <code>UISearchResultsUpdating</code> protocol.</p><br><p>Now, whenever the user adds or removes text in the search bar, the <code>UISearchController</code> will inform the <code>MasterViewController</code> class of the change via this method. The method itself simply calls a helper method (which you&#8217;ll define soon) with the text currently in the search bar.</p><br><p><code>filter()</code> takes a closure of type <code>(candy: Candy) -&gt; Bool</code>. It then loops over all the elements of the array, and calls the closure, passing in the current element, for every one of the elements.</p><br><p>You can use this to determine whether a candy should be part of the search results that are presented to the user. To do so, you need to return <code>true</code> if the current candy is to be included in the filtered array, or <code>false</code> if not.</p><br><p>To determine this, <code>containsString(:)</code> is used to check to see if the name of the candy contains <code>searchText</code>. But before doing the comparison, you convert both strings to their lowercase equivalents using the <code>lowercaseString</code> method. </p><br><div class="note"><em>Note:</em> Most of the time, users don&#8217;t bother with the case of letters when performing a search so by only comparing the lowercase version of what they type with the lowercase version of the name of each candy you can easily return a case-insensitive &#8216;match&#8217;. Now, you can type &#8220;Chocolate&#8221; or &#8220;chocolate&#8221; and either will return a matching candy. How useful is that?! :]</div><br><p>Build and run the app now; you’ll notice that there is now a Search Bar above the table.</p><br><p>However, if you enter some search text you still don&#8217;t see any filtered results. What gives? This is simply because you haven’t yet written the code to let the table view know when to use the filtered results.</p><br><p>Back in <em>MasterViewController.swift</em>, replace <code>tableView(_:numberOfRowsInSection:)</code> with the following:</p>

<div class="wp_codebox"><table><tr id="p1137727"><td class="code" id="p113772code7"><pre class="swift" style="font-family:monospace;"><span style="color: #a61390;">override</span> <span style="color: #a61390;">func</span> tableView<span style="color: #002200;">&#40;</span>tableView<span style="color: #002200;">:</span> <span style="color: #400080;">UITableView</span>, numberOfRowsInSection section<span style="color: #002200;">:</span> <span style="color: #a61390;">Int</span><span style="color: #002200;">&#41;</span> <span style="color: #002200;">-</span>&gt; <span style="color: #a61390;">Int</span> <span style="color: #002200;">&#123;</span><br>  <span style="color: #a61390;">if</span> searchController.active <span style="color: #002200;">&amp;&amp;</span> searchController.searchBar.text <span style="color: #002200;">!=</span> <span style="color: #bf1d1a;">&quot;&quot;</span> <span style="color: #002200;">&#123;</span><br>    <span style="color: #a61390;">return</span> filteredCandies.<span style="color: #a61390;">count</span><br>  <span style="color: #002200;">&#125;</span><br>  <span style="color: #a61390;">return</span> candies.<span style="color: #a61390;">count</span><br><span style="color: #002200;">&#125;</span></pre></td></tr></table></div>

<p>Not much has changed here, you simply check whether the user is searching or not, and use either the filtered or normal candies as a data source for the table.</p><br><p>Next, replace <code>tableView(_:cellForRowAtIndexPath:)</code> with:</p>

<div class="wp_codebox"><table><tr id="p1137728"><td class="code" id="p113772code8"><pre class="swift" style="font-family:monospace;"><span style="color: #a61390;">override</span> <span style="color: #a61390;">func</span> tableView<span style="color: #002200;">&#40;</span>tableView<span style="color: #002200;">:</span> <span style="color: #400080;">UITableView</span>, cellForRowAtIndexPath indexPath<span style="color: #002200;">:</span> <span style="color: #400080;">NSIndexPath</span><span style="color: #002200;">&#41;</span> <span style="color: #002200;">-</span>&gt; <span style="color: #400080;">UITableViewCell</span> <span style="color: #002200;">&#123;</span><br>  <span style="color: #a61390;">let</span> cell <span style="color: #002200;">=</span> tableView.dequeueReusableCellWithIdentifier<span style="color: #002200;">&#40;</span><span style="color: #bf1d1a;">&quot;Cell&quot;</span>, forIndexPath<span style="color: #002200;">:</span> indexPath<span style="color: #002200;">&#41;</span><br>  <span style="color: #a61390;">let</span> candy<span style="color: #002200;">:</span> Candy<br>  <span style="color: #a61390;">if</span> searchController.active <span style="color: #002200;">&amp;&amp;</span> searchController.searchBar.text <span style="color: #002200;">!=</span> <span style="color: #bf1d1a;">&quot;&quot;</span> <span style="color: #002200;">&#123;</span><br>    candy <span style="color: #002200;">=</span> filteredCandies<span style="color: #002200;">&#91;</span>indexPath.row<span style="color: #002200;">&#93;</span><br>  <span style="color: #002200;">&#125;</span> <span style="color: #a61390;">else</span> <span style="color: #002200;">&#123;</span><br>    candy <span style="color: #002200;">=</span> candies<span style="color: #002200;">&#91;</span>indexPath.row<span style="color: #002200;">&#93;</span><br>  <span style="color: #002200;">&#125;</span><br>  cell.textLabel?.text <span style="color: #002200;">=</span> candy.name<br>  cell.detailTextLabel?.text <span style="color: #002200;">=</span> candy.category<br>  <span style="color: #a61390;">return</span> cell<br><span style="color: #002200;">&#125;</span></pre></td></tr></table></div>

<p>Both methods now refer to the <code>active</code> property of <code>searchController</code> to determine which array to display. </p><br><p>When the user clicks in the search field of the Search Bar, <code>active</code> will automatically be set to <code>true</code>. If the search controller is active, you then see if the user has actually typed something into the search field. If they have, the data returned is taken from the <code>filteredCandies</code> array. Otherwise, the data comes from the full list of items.</p><br><p>Recall that the search controller automatically handles showing and hiding the results table, so all your code has to do is provide the correct data (filtered or non-filtered) depending on the state of the controller and whether the user has searched for anything.</p><br><p><a href="http://www.raywenderlich.com/wp-content/uploads/2015/09/ragecomic.png" target="_blank" rel="external"><img src="http://www.raywenderlich.com/wp-content/uploads/2015/09/ragecomic.png" alt="ragecomic" width="651" height="481" class="aligncenter size-full wp-image-114198" srcset="https://cdn4.raywenderlich.com/wp-content/uploads/2015/09/ragecomic.png 651w, https://cdn4.raywenderlich.com/wp-content/uploads/2015/09/ragecomic-433x320.png 433w" sizes="(max-width: 651px) 100vw, 651px"></a></p><br><p>Build and run the app. You’ve got a functioning Search Bar that filters the rows of the main table. Huzzah! </p><br><p><a href="http://www.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Filter.png" target="_blank" rel="external"><img src="http://www.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Filter-281x500.png" alt="UISearchController-Filter" width="281" height="500" class="aligncenter size-large wp-image-113864" srcset="https://cdn5.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Filter-281x500.png 281w, https://cdn5.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Filter-180x320.png 180w, https://cdn5.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Filter.png 750w" sizes="(max-width: 281px) 100vw, 281px"></a></p><br><p>Play with the app for a bit to see how you can search for various candies.</p><br><p>There&#8217;s still one more problem. When you select a row from the search results list, you may notice that the detail view shown can be of the wrong candy! Time to fix that.</p><br><h2>Sending Data to a Detail View</h2><br><p>When sending information to a detail view controller, you need to ensure that the view controller knows which context the user is working with: the full table list, or the search results. Still in <em>MasterViewController.swift</em>, in <code>prepareForSegue(_:sender:)</code>, find the following code:</p>

<div class="wp_codebox"><table><tr id="p1137729"><td class="code" id="p113772code9"><pre class="swift" style="font-family:monospace;"><span style="color: #a61390;">let</span> candy <span style="color: #002200;">=</span> candies<span style="color: #002200;">&#91;</span>indexPath.row<span style="color: #002200;">&#93;</span></pre></td></tr></table></div>

<p>Then replace it with the following:</p>

<div class="wp_codebox"><table><tr id="p11377210"><td class="code" id="p113772code10"><pre class="swift" style="font-family:monospace;"><span style="color: #a61390;">let</span> candy<span style="color: #002200;">:</span> Candy<br><span style="color: #a61390;">if</span> searchController.active <span style="color: #002200;">&amp;&amp;</span> searchController.searchBar.text <span style="color: #002200;">!=</span> <span style="color: #bf1d1a;">&quot;&quot;</span> <span style="color: #002200;">&#123;</span><br>  candy <span style="color: #002200;">=</span> filteredCandies<span style="color: #002200;">&#91;</span>indexPath.row<span style="color: #002200;">&#93;</span><br><span style="color: #002200;">&#125;</span> <span style="color: #a61390;">else</span> <span style="color: #002200;">&#123;</span><br>  candy <span style="color: #002200;">=</span> candies<span style="color: #002200;">&#91;</span>indexPath.row<span style="color: #002200;">&#93;</span><br><span style="color: #002200;">&#125;</span></pre></td></tr></table></div>

<p>Here you performed the same check that <code>tableView(<em>:numberOfRowsInSection:)</em></code> and <code>tableView(:cellForRowAtIndexPath:)</code> do, but now you&#8217;re providing the proper candy object when performing a segue to the detail view controller.</p><br><p>Build and run the code at this point and see how the app now navigates correctly to the Detail View from either the main table or the search table with ease.</p><br><p><a href="http://www.raywenderlich.com/wp-content/uploads/2015/09/CandySearch-DetailView.png" target="_blank" rel="external"><img src="http://www.raywenderlich.com/wp-content/uploads/2015/09/CandySearch-DetailView-281x500.png" alt="CandySearch-DetailView" width="281" height="500" class="aligncenter size-large wp-image-114436" srcset="https://cdn2.raywenderlich.com/wp-content/uploads/2015/09/CandySearch-DetailView-281x500.png 281w, https://cdn2.raywenderlich.com/wp-content/uploads/2015/09/CandySearch-DetailView-180x320.png 180w, https://cdn2.raywenderlich.com/wp-content/uploads/2015/09/CandySearch-DetailView.png 750w" sizes="(max-width: 281px) 100vw, 281px"></a></p><br><h2>Creating a Scope Bar to Filter Results</h2><br><p>If you wish to give your users another way to filter their results, you can add a <em>Scope Bar</em> in conjunction with your search bar in order to filter out items by their category. The categories you will filter on are the ones you assigned to the <code>Candy</code> object when you created the candies array: <em>Chocolate</em>, <em>Hard</em>, and <em>Other</em>.</p><br><p>First, you have to create a scope bar in <code>MasterViewController</code>. The scope bar is a segmented control that narrows down a search by only searching in certain scopes. A scope is really what you define it as. In this case it&#8217;s a candy&#8217;s category, but scopes could also be types, ranges, or something completely different.</p><br><p>Using the scope bar is as easy as implementing one additional delegate method.</p><br><p>In <em>MasterViewController.swift</em>, you&#8217;ll need to add another extension that conforms to <code>UISearchBarDelegate</code>. Add the following after your <code>UISearchResultsUpdating</code> extension:</p>

<div class="wp_codebox"><table><tr id="p11377211"><td class="code" id="p113772code11"><pre class="swift" style="font-family:monospace;">extension MasterViewController<span style="color: #002200;">:</span> <span style="color: #2a6f76;">UISearchBarDelegate</span> <span style="color: #002200;">&#123;</span><br>  <span style="color: #a61390;">func</span> searchBar<span style="color: #002200;">&#40;</span>searchBar<span style="color: #002200;">:</span> <span style="color: #400080;">UISearchBar</span>, selectedScopeButtonIndexDidChange selectedScope<span style="color: #002200;">:</span> <span style="color: #a61390;">Int</span><span style="color: #002200;">&#41;</span> <span style="color: #002200;">&#123;</span><br>    filterContentForSearchText<span style="color: #002200;">&#40;</span>searchBar.text<span style="color: #002200;">!</span>, scope<span style="color: #002200;">:</span> searchBar.scopeButtonTitles<span style="color: #002200;">!</span><span style="color: #002200;">&#91;</span>selectedScope<span style="color: #002200;">&#93;</span><span style="color: #002200;">&#41;</span><br>  <span style="color: #002200;">&#125;</span><br><span style="color: #002200;">&#125;</span></pre></td></tr></table></div>

<p>This delegate methods gets called when the user switches the scope in the scope bar. When that happens, you want to redo the filtering, so you call <code>filterContentForSearchText(<em>:scope:)</em></code> with the new scope.</p><br><p>Now modify <code>filterContentForSearchText(:scope:)</code> to take the supplied scope into account:</p>

<div class="wp_codebox"><table><tr id="p11377212"><td class="code" id="p113772code12"><pre class="swift" style="font-family:monospace;"><span style="color: #a61390;">func</span> filterContentForSearchText<span style="color: #002200;">&#40;</span>searchText<span style="color: #002200;">:</span> <span style="color: #a61390;">String</span>, scope<span style="color: #002200;">:</span> <span style="color: #a61390;">String</span> <span style="color: #002200;">=</span> <span style="color: #bf1d1a;">&quot;All&quot;</span><span style="color: #002200;">&#41;</span> <span style="color: #002200;">&#123;</span><br>  filteredCandies <span style="color: #002200;">=</span> candies.<span style="color: #a61390;">filter</span> <span style="color: #002200;">&#123;</span> candy <span style="color: #a61390;">in</span><br>    <span style="color: #a61390;">let</span> categoryMatch <span style="color: #002200;">=</span> <span style="color: #002200;">&#40;</span>scope <span style="color: #002200;">==</span> <span style="color: #bf1d1a;">&quot;All&quot;</span><span style="color: #002200;">&#41;</span> || <span style="color: #002200;">&#40;</span>candy.category <span style="color: #002200;">==</span> scope<span style="color: #002200;">&#41;</span><br>    <span style="color: #a61390;">return</span>  categoryMatch <span style="color: #002200;">&amp;&amp;</span> candy.name.lowercaseString.containsString<span style="color: #002200;">&#40;</span>searchText.lowercaseString<span style="color: #002200;">&#41;</span><br>  <span style="color: #002200;">&#125;</span><br>&nbsp;<br>  tableView.reloadData<span style="color: #002200;">&#40;</span><span style="color: #002200;">&#41;</span><br><span style="color: #002200;">&#125;</span></pre></td></tr></table></div>

<p>This now checks to see if the scope provided is either set to &#8220;All&#8221; or it matches the category of the candy. Only when this is the case is the candy name tested to see if the candy should be added to the <code>filteredCandies</code>.</p><br><p>You&#8217;re almost there, but the scope filtering mechanism doesn&#8217;t quite work yet. You&#8217;ll need to modify <code>updateSearchResultsForSearchController(_:)</code> in the first class extension you created to send the currently selected scope:</p>

<div class="wp_codebox"><table><tr id="p11377213"><td class="code" id="p113772code13"><pre class="swift" style="font-family:monospace;"><span style="color: #a61390;">func</span> updateSearchResultsForSearchController<span style="color: #002200;">&#40;</span>searchController<span style="color: #002200;">:</span> UISearchController<span style="color: #002200;">&#41;</span> <span style="color: #002200;">&#123;</span><br>  <span style="color: #a61390;">let</span> searchBar <span style="color: #002200;">=</span> searchController.searchBar<br>  <span style="color: #a61390;">let</span> scope <span style="color: #002200;">=</span> searchBar.scopeButtonTitles<span style="color: #002200;">!</span><span style="color: #002200;">&#91;</span>searchBar.selectedScopeButtonIndex<span style="color: #002200;">&#93;</span><br>  filterContentForSearchText<span style="color: #002200;">&#40;</span>searchController.searchBar.text<span style="color: #002200;">!</span>, scope<span style="color: #002200;">:</span> scope<span style="color: #002200;">&#41;</span><br><span style="color: #002200;">&#125;</span></pre></td></tr></table></div>

<p>The only problem left is that the user doesn&#8217;t actually see a scope bar yet! To add the scope bar, navigate to <em>MasterViewController.swift</em>, after the search controller setup in <code>viewDidLoad()</code>, and add the following code:</p>

<div class="wp_codebox"><table><tr id="p11377214"><td class="code" id="p113772code14"><pre class="swift" style="font-family:monospace;">searchController.searchBar.scopeButtonTitles <span style="color: #002200;">=</span> <span style="color: #002200;">&#91;</span><span style="color: #bf1d1a;">&quot;All&quot;</span>, <span style="color: #bf1d1a;">&quot;Chocolate&quot;</span>, <span style="color: #bf1d1a;">&quot;Hard&quot;</span>, <span style="color: #bf1d1a;">&quot;Other&quot;</span><span style="color: #002200;">&#93;</span><br>searchController.searchBar.delegate <span style="color: #002200;">=</span> <span style="color: #a61390;">self</span></pre></td></tr></table></div>

<p>This will add a scope bar to the search bar, with the titles that match the categories you assigned to your candy objects. You also include a catch-all category called <em>&#8220;All&#8221;</em> that you will use to ignore the candy category in the search altogether.</p><br><p>Now, when you type, the selected scope button will be used in conjunction with the search text.</p><br><p>Build and run your app. Try entering some search text, and changing the scope.</p><br><p><a href="http://www.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Filter-with-Scope.png" target="_blank" rel="external"><img src="http://www.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Filter-with-Scope-281x500.png" alt="UISearchController-Filter with Scope" width="281" height="500" class="aligncenter size-large wp-image-113863" srcset="https://cdn2.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Filter-with-Scope-281x500.png 281w, https://cdn2.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Filter-with-Scope-180x320.png 180w, https://cdn2.raywenderlich.com/wp-content/uploads/2015/09/UISearchController-Filter-with-Scope.png 750w" sizes="(max-width: 281px) 100vw, 281px"></a></p><br><p>Type in &#8220;caramel&#8221; with the scope set to All. It shows up in the list, but when you change the scope to Chocolate, &#8220;caramel&#8221; disappears because it&#8217;s not a chocolate.</p><br><h2>Where To Go From Here?</h2><br><p>Congratulations &#8211; you now have a working app that allows you to search directly from the main table view. Here is a <a href="http://www.raywenderlich.com/wp-content/uploads/2015/09/CandySearch.zip" target="_blank" rel="external">downloadable sample project</a> with all of the code from the above tutorial.</p><br><p>Table views are used in all kinds of apps, and offering a search option is a nice touch for usability. With <code>UISearchBar</code> and the <code>UISearchController</code>, iOS provides much of the functionality out of the box so there&#8217;s no excuse for not using it. The ability to search a large table view is something that today&#8217;s users expect; when they find it isn&#8217;t present, they won’t be happy campers.</p><br><div id="attachment_19061" style="width: 410px" class="wp-caption aligncenter"><img src="http://www.raywenderlich.com/wp-content/uploads/2012/07/nosearchfunction.jpg" alt="Don&#039;t let this happen to your users. Always give them a search option." width="400" height="361" class="size-full wp-image-19061" srcset="https://cdn2.raywenderlich.com/wp-content/uploads/2012/07/nosearchfunction.jpg 400w, https://cdn2.raywenderlich.com/wp-content/uploads/2012/07/nosearchfunction-250x225.jpg 250w, https://cdn2.raywenderlich.com/wp-content/uploads/2012/07/nosearchfunction-354x320.jpg 354w" sizes="(max-width: 400px) 100vw, 400px"><p class="wp-caption-text">Don&#8217;t let this happen to your users. Always give them a search option.</p></div><br><p>I hope to see you adding search capabilities to your table view apps in the future. If you have any questions or comments, please join the forum discussion below.</p>

</div>  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">


</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://yoursite.com/2016/09/14/UISearchController-使用指导/" data-title="UISearchController 使用指导 | 跳跳魔王的博客" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 

<div class="next">
<a href="/2016/09/08/项目结束后的一些思考/"  title="项目结束后的一些思考">
 <strong>下一篇：</strong><br/> 
 <span>项目结束后的一些思考
</span>
</a>
</div>

</nav>

	

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">1.</span> <span class="toc-text">准备开始</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">2.</span> <span class="toc-text">填充 Table View</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">3.</span> <span class="toc-text">UISearchController介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#undefined"><span class="toc-number">3.1.</span> <span class="toc-text">UISearchResultsUpdating 和 Filtering</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">4.</span> <span class="toc-text">Sending Data to a Detail View</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">5.</span> <span class="toc-text">Creating a Scope Bar to Filter Results</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#undefined"><span class="toc-number">6.</span> <span class="toc-text">Where To Go From Here?</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  


  

  

  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">Weibo</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 大家好,我是熙健的iOS工程师. <br/>
			这是我的博客,努力奋斗.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2016 
		
		<a href="/about" target="_blank" title="跳跳魔王">跳跳魔王</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>









<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
